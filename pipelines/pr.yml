trigger:
  - none

pool:
  vmImage: ubuntu-latest

steps:
  - bash: npm ci
    displayName: Install dependencies

  - bash: |
      if ! npx nx format:check --all; then
        MSG='Some file are improperly formatted. See logs for a list.'
        echo "##vso[task.logissue type=error]$MSG"
        exit 1
      fi
    displayName: Check formatting
    continueOnError: true

  - bash: |
      if ! npx nx run-many --target=lint --all; then
        MSG='Lint errors found. See logs for a list.'
        echo "##vso[task.logissue type=error]$MSG"
        exit 1
      fi
    displayName: Linting
    continueOnError: true

  - bash: npx nx run-many --target=test -- --reporters=jest-junit --verbose --output-style=static
    displayName: Unit Tests
    continueOnError: true

  - task: PublishTestResults@2
    inputs:
      testResultsFormat: JUnit
      testResultsFiles: junit.xml

  - bash: npx nx run-many --target=build
    displayName: Build changed projects
