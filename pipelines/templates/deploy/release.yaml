parameters:
  - name: serviceConnection
    type: string
    default: ''
  - name: containerRegistryName
    type: string
    default: ''
  - name: appName
    type: string
    values:
      - address
      - annex-vii
      - annex-vii-bulk
      - app-green-list-waste
      - app-waste-tracking-service
      - feedback
      - limited-audience
      - reference-data
      - uk-waste-movements
      - waste-tracking-gateway
  - name: appNameTag
    type: string
    values:
      - address
      - annex_vii
      - annex_vii_bulk
      - app_green_list_waste
      - app_waste_tracking_service
      - feedback
      - limited_audience
      - reference_data
      - uk_waste_movements
      - waste_tracking_gateway
  - name: deployChart
    type: string
    default: ''

steps:
  - task: AzureCLI@2
    name: repository_${{ parameters.appNameTag }}
    displayName: ACR repository ${{ parameters.appName }}
    condition: ${{ parameters.deployChart }}
    inputs:
      azureSubscription: ${{ parameters.serviceConnection }}
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        response=$(az acr repository show-tags \
          --repository $REPOSITORY_NAME \
          --orderby time_desc \
          --top 1
        )
        echo "Latest Helm chart tag for: ${REPOSITORY_NAME}"
        echo $response | jq -r .[]
        echo "##vso[task.setvariable variable=chartTag;isoutput=true]$( \
          echo $response | jq -r .[] \
        )"
    env:
      AZURE_DEFAULTS_ACR: ${{ parameters.containerRegistryName }}
      REPOSITORY_NAME: charts/wts/${{ parameters.appName }}
